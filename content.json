{"meta":{"title":"scr1pt_k1ddi3' blog","subtitle":"","description":"","author":"scr1pt_k1ddi3","url":"https://scr1pt-k1ddi3.github.io","root":"/"},"pages":[{"title":"about","date":"2022-04-13T10:12:53.000Z","updated":"2022-04-18T15:55:34.050Z","comments":true,"path":"about.html","permalink":"https://scr1pt-k1ddi3.github.io/about.html","excerpt":"","text":"💻 关于博客本站纯属瞎胡闹搞的，请各位客官不要轻信❤️：😃 关于我😎 个人简介本人是一只小傻鸟🐣🐥🐤，大菜狗🐶，还请各位客官多多包含,多多指教🙏🙏🙏。😷参悟真谛：佛曰：俱以豆皤想呐不薩缽多礙顛奢那皤死冥爍悉究侄特皤苦倒老咒侄真盡苦呐遠奢遮吉皤瑟冥特依哆數穆咒利俱爍"},{"title":"文章归档","date":"2022-04-13T14:16:19.393Z","updated":"2022-04-13T13:25:15.839Z","comments":true,"path":"archive.html","permalink":"https://scr1pt-k1ddi3.github.io/archive.html","excerpt":"","text":""},{"title":"friends","date":"2022-04-18T14:51:39.000Z","updated":"2022-04-18T15:50:53.074Z","comments":true,"path":"PY.html","permalink":"https://scr1pt-k1ddi3.github.io/PY.html","excerpt":"","text":"你我弟兄，辈子弟兄。其他弟兄，都是冒充！ 💪😎 scr1pt_k1ddi3’弟兄❤️❤️❤️"},{"title":"categories","date":"2022-04-13T10:54:10.000Z","updated":"2022-04-13T13:20:09.026Z","comments":true,"path":"categories/index.html","permalink":"https://scr1pt-k1ddi3.github.io/categories/index.html","excerpt":"","text":""}],"posts":[{"title":"BUUCTF 2018 Online Tool","slug":"Tool","date":"2022-04-17T04:51:43.000Z","updated":"2022-04-17T12:25:20.689Z","comments":true,"path":"2022/04/17/Tool/","link":"","permalink":"https://scr1pt-k1ddi3.github.io/2022/04/17/Tool/","excerpt":"","text":"&lt;?php if (isset($_SERVER[&#39;HTTP_X_FORWARDED_FOR&#39;])) &#123; $_SERVER[&#39;REMOTE_ADDR&#39;] = $_SERVER[&#39;HTTP_X_FORWARDED_FOR&#39;]; &#125; if(!isset($_GET[&#39;host&#39;])) &#123; highlight_file(__FILE__); &#125; else &#123; $host = $_GET[&#39;host&#39;]; $host = escapeshellarg($host); $host = escapeshellcmd($host); $sandbox = md5(&quot;glzjin&quot;. $_SERVER[&#39;REMOTE_ADDR&#39;]); echo &#39;you are in sandbox &#39;.$sandbox; @mkdir($sandbox); chdir($sandbox); echo system(&quot;nmap -T5 -sT -Pn --host-timeout 2 -F &quot;.$host); &#125; 这里面主要是 $host = escapeshellarg($host);$host = escapeshellcmd($host); 这里会产生漏洞。 escapeshellarg和escapeshellcmd这两个函数在一起使用时会造成漏洞。 escapeshellarg 这两个函数都是防止命令执行时转义’的函数。escapellarg是将’转义，escapelshellcmd是在\\和’等之前加\\转义。这样会造成漏洞： escapeshellcmd 这两个函数都是防止命令执行时转义’的函数。escapellarg是将’转义，escapelshellcmd是在\\和’等之前加\\转义。这样会造成漏洞： 我们详细分析一下： 传入的参数是：172.17.0.2&#39; -v -d a=1 经过escapeshellarg处理后变成了&#39;172.17.0.2&#39;\\&#39;&#39; -v -d a=1&#39;，即先对单引号转义，再用单引号将左右两部分括起来从而起到连接的作用。 经过escapeshellcmd处理后变成&#39;172.17.0.2&#39;\\\\&#39;&#39; -v -d a=1\\&#39;，这是因为escapeshellcmd对\\以及最后那个不配对儿的引号进行了转义：http://php.net/manual/zh/function.escapeshellcmd.php 最后执行的命令是curl &#39;172.17.0.2&#39;\\\\&#39;&#39; -v -d a=1\\&#39;，由于中间的\\\\被解释为\\而不再是转义字符，所以后面的&#39;没有被转义，与再后面的&#39;配对儿成了一个空白连接符。所以可以简化为curl 172.17.0.2\\ -v -d a=1&#39;，即向172.17.0.2\\发起请求，POST 数据为a=1&#39;。 回到mail中，我们的 payload 最终在执行时变成了&#39;-fa&#39;\\\\&#39;&#39;\\( -OQueueDirectory=/tmp -X/var/www/html/test.php \\)@a.com\\&#39;，分割后就是-fa\\(、-OQueueDirectory=/tmp、-X/var/www/html/test.php、)@a.com&#39;，最终的参数就是这样被注入的。 ps：这里好像只能是linux环境下才行。 这里就是通过第一次的转义变成了&#39;172.17.0.2&#39;\\&#39;&#39; -v -d a=1&#39;，然后这时是172.17.0.2&#39; -v -d a=1这样，经过第二次后是&#39;172.17.0.2&#39;\\\\&#39;&#39; -v -d a=1\\&#39;，\\会被认为是\\所以变成了172.17.0.2\\ -v -d a=1&#39;这样的命令。 这时候搜索可以发现在nmap命令中 有一个参数-oG可以实现将命令和结果写到文件 这个命令就是我们的输入可控！然后写入到文件！OK很自然的想到了上传一个一句话木马了… ?host&#x3D;’ -oG hack.php ‘ (45条消息) BUUCTF 2018 Online Tool_kid的博客-CSDN博客_buuctf escapeshellarg与escapeshellcmd共伤 - NineOne_E - 博客园 (cnblogs.com) PHP escapeshellarg()+escapeshellcmd() 之殇 (seebug.org)","categories":[{"name":"CTF","slug":"CTF","permalink":"https://scr1pt-k1ddi3.github.io/categories/CTF/"}],"tags":[{"name":"CTF","slug":"CTF","permalink":"https://scr1pt-k1ddi3.github.io/tags/CTF/"},{"name":"Web","slug":"Web","permalink":"https://scr1pt-k1ddi3.github.io/tags/Web/"}]}],"categories":[{"name":"CTF","slug":"CTF","permalink":"https://scr1pt-k1ddi3.github.io/categories/CTF/"}],"tags":[{"name":"CTF","slug":"CTF","permalink":"https://scr1pt-k1ddi3.github.io/tags/CTF/"},{"name":"Web","slug":"Web","permalink":"https://scr1pt-k1ddi3.github.io/tags/Web/"}]}